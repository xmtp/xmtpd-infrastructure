apiVersion: apps/v1
kind: Deployment
metadata:
  name: anvil-node
  labels:
    app: anvil
spec:
  replicas: 1
  selector:
    matchLabels:
      app: anvil
  template:
    metadata:
      labels:
        app: anvil
    spec:
      containers:
        - name: anvil
          image: ghcr.io/xmtp/contracts:0.5.3
          ports:
            - name: anvil-port
              containerPort: 8545
              protocol: TCP

---
apiVersion: v1
kind: Service
metadata:
  name: anvil-service
spec:
  selector:
    app: anvil
  ports:
    - protocol: TCP
      port: 8545
      targetPort: 8545
  type: ClusterIP
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: xmtp-env
data:
  XMTPD_SETTLEMENT_CHAIN_WSS_URL: "ws://anvil-service:8545"
  XMTPD_SETTLEMENT_CHAIN_RPC_URL: "http://anvil-service:8545"
  REGISTER_NODE_OWNER_ADDRESS: "0x70997970C51812dc3A010C7d01b50e0d17dc79C8"
  REGISTER_NODE_ADMIN_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
  REGISTER_NODE_PUBKEY: "0x02ba5734d8f7091719471e7f7ed6b9df170dc70cc661ca05e688601ad984f068b0"
  REGISTER_NODE_HTTP_ADDRESS: "http://xmtpd"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: anvil-config
data:
  contracts.json: |
    {
      "appChainDeploymentBlock": 0,
      "appChainFactory": "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512",
      "appChainGateway": "0x0000000000000000000000000000000000000000",
      "appChainId": 31337,
      "appChainParameterRegistry": "0x1aF9c0a400767fA5156F11D125014974517d1b71",
      "deployer": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
      "distributionManager": "0x644024442d659Db13dCc84C785D040065c666A77",
      "feeToken": "0x8bC46814343DAb8Ef394311f1b9A064f2a9E38b8",
      "groupMessageBroadcaster": "0xB86b994859Fe97b2A23236EF9548041671db6718",
      "identityUpdateBroadcaster": "0x08AEB6338Fd56dF6343B01C72576379E6b184078",
      "nodeRegistry": "0x5CBdf3Db993931B7DED3b116489764ee25052442",
      "payerRegistry": "0x28A39815cc3E5c91Cac463C08907C792A57113D4",
      "payerReportManager": "0x0bA60F0d5eccA31A76644e708afcA506EaF9da23",
      "rateRegistry": "0x94d4DaC20c2CFBc588B495B31f71d007B62F0da0",
      "settlementChainDeploymentBlock": 0,
      "settlementChainFactory": "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512",
      "settlementChainGateway": "0x0000000000000000000000000000000000000000",
      "settlementChainId": 31337,
      "settlementChainParameterRegistry": "0x1aF9c0a400767fA5156F11D125014974517d1b71",
      "underlyingFeeToken": "0x20d28A690751f90Cd24D9EAaCF5dcDBD794fE6A5"
    }

---
apiVersion: batch/v1
kind: Job
metadata:
  name: register-node
spec:
  template:
    spec:
      restartPolicy: OnFailure
      volumes:
        - name: anvil-config-volume
          configMap:
            name: anvil-config
      containers:
        - name: register
          image: ghcr.io/xmtp/xmtpd-cli:latest
          env:
            - name: XMTPD_CONTRACTS_CONFIG_FILE_PATH
              value: /etc/xmtp/contracts.json
          volumeMounts:
            - name: anvil-config-volume
              mountPath: /etc/xmtp
              readOnly: true
          envFrom:
            - configMapRef:
                name: xmtp-env
          command: ["/bin/sh", "-c"]
          args:
            - |
              xmtpd-cli register-node \
                --http-address="$REGISTER_NODE_HTTP_ADDRESS" \
                --node-owner-address="$REGISTER_NODE_OWNER_ADDRESS" \
                --admin.private-key="$REGISTER_NODE_ADMIN_KEY" \
                --node-signing-key-pub="$REGISTER_NODE_PUBKEY"
        - name: enable
          image: ghcr.io/xmtp/xmtpd-cli:latest
          env:
            - name: XMTPD_CONTRACTS_CONFIG_FILE_PATH
              value: /etc/xmtp/contracts.json
          volumeMounts:
            - name: anvil-config-volume
              mountPath: /etc/xmtp
              readOnly: true
          envFrom:
            - configMapRef:
                name: xmtp-env
          command: [ "/bin/sh", "-c" ]
          args:
            - |
              xmtpd-cli add-node-to-network \
                --admin.private-key="$REGISTER_NODE_ADMIN_KEY" \
                --node-id=100